---
- name: Install Packages and Configure macOS
  hosts: localhost
  become: yes

  vars:
    package_list_path: "./packages.txt"
    neovim_config_repo: "https://github.com/W-Kanzashi/nvim.git"
    neovim_config_dest: "~/.config/nvim"
    applications_folder: "/Applications"

  tasks:
    - name: Check if Homebrew is installed
      command: which brew
      register: brew_path
      ignore_errors: yes

    - name: Install Homebrew if not installed
      shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      when: brew_path.rc != 0
      become: no

    - name: Check for Homebrew local modifications
      shell: git -C "$(brew --repository)" diff-index --quiet HEAD --
      register: brew_git_check
      ignore_errors: yes
      become: no

    - name: Display warning if Homebrew has local modifications
      debug:
        msg: "WARNING: Local modifications detected in Homebrew repository. Skipping 'brew update' to preserve your changes."
      when: brew_git_check.rc != 0

    - name: Ensure Homebrew is up to date
      command: brew update
      when: brew_path.rc == 0 and brew_git_check.rc == 0
      become: no

    - name: Read package list into variable
      set_fact:
        packages: "{{ lookup('file', package_list_path).splitlines() }}"

    - name: Separate formulae and casks
      set_fact:
        formulae: "{{ packages | reject('search', '^cask-') | list }}"
        casks: "{{ packages | select('search', '^cask-') | map('regex_replace', '^cask-', '') | list }}"

    - name: Fetch list of installed formulae
      command: brew list --formula
      register: installed_formulae
      become: no

    - name: Determine which formulae to install
      set_fact:
        formulae_to_install: "{{ formulae | difference(installed_formulae.stdout_lines) }}"

    - name: Install formulae using Homebrew
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ formulae_to_install }}"
      when: ansible_os_family == "Darwin"
      become: no

    - name: Fetch list of installed casks
      command: brew list --cask
      register: installed_casks
      become: no

    - name: Determine which casks to install
      set_fact:
        casks_to_install: "{{ casks | difference(installed_casks.stdout_lines) }}"

    - name: Install casks using Homebrew
      community.general.homebrew_cask:
        name: "{{ item }}"
        state: present
      loop: "{{ casks_to_install }}"
      when: ansible_os_family == "Darwin"
      become: no

    - name: Install git if not present
      community.general.homebrew:
        name: git
        state: present
      when: ansible_os_family == "Darwin"
      become: no

    - name: Clone Neovim configuration repository
      git:
        repo: "{{ neovim_config_repo }}"
        dest: "{{ neovim_config_dest }}"
        update: yes
      become: no
      when: ansible_os_family == "Darwin"

    - name: Prompt for Ansible Vault password
      pause:
        prompt: "Enter Ansible Vault password"
        echo: no
      register: vault_password
      when: ansible_os_family == "Darwin"

    - name: Find encrypted files in vault directory
      find:
        paths: "../vault"
        recurse: yes
        file_type: file
      register: vault_files
      become: no

    - name: Create vault password file temporarily
      copy:
        content: "{{ vault_password.user_input }}"
        dest: "/tmp/.vault_pass"
        mode: "0600"
      become: no
      when: vault_files.matched > 0

    - name: Decrypt vault files
      shell: |
        if head -n1 "{{ item.path }}" | grep -q '$ANSIBLE_VAULT'; then
          ansible-vault decrypt "{{ item.path }}" --vault-password-file /tmp/.vault_pass 2>/dev/null || echo "Already decrypted or error: {{ item.path }}"
        fi
      loop: "{{ vault_files.files }}"
      become: no
      when: vault_files.matched > 0
      ignore_errors: yes

    - name: Remove vault password file
      file:
        path: "/tmp/.vault_pass"
        state: absent
      become: no
      when: vault_files.matched > 0

    - name: Find config files in vault/config directory
      find:
        paths: "../vault/config"
        recurse: yes
        file_type: file
      register: config_files
      become: no

    - name: Copy config files to home directory
      copy:
        src: "{{ item.path }}"
        dest: "{{ ansible_env.HOME }}/{{ item.path | regex_replace('^.*/vault/config/', '') }}"
        mode: preserve
      loop: "{{ config_files.files }}"
      become: no
      when: config_files.matched > 0

    - name: Install NVM (Node Version Manager)
      shell: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
      args:
        creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"
      become: no
      when: ansible_os_family == "Darwin"

    - name: Install Node.js 24.10 using NVM
      shell: |
        export NVM_DIR="{{ ansible_env.HOME }}/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 24.10
        nvm use 24.10
        nvm alias default 24.10
      args:
        executable: /bin/zsh
      become: no
      when: ansible_os_family == "Darwin"

    - name: Install pnpm latest version
      shell: |
        export NVM_DIR="{{ ansible_env.HOME }}/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        npm install -g pnpm
      args:
        executable: /bin/zsh
      become: no
      when: ansible_os_family == "Darwin"

    - name: Ensure Syncthing config directory exists
      file:
        path: "{{ ansible_env.HOME }}/Library/Application Support/Syncthing"
        state: directory
        mode: "0755"
      become: no
      when: ansible_os_family == "Darwin"

    - name: Copy Syncthing configuration files
      copy:
        src: "{{ item }}"
        dest: "{{ ansible_env.HOME }}/Library/Application Support/Syncthing/"
        mode: "0600"
      with_fileglob:
        - "../vault/Library/Application Support/Syncthing/*"
      become: no
      when: ansible_os_family == "Darwin"

    - name: Include macOS configuration
      include_tasks: macos.yml
      when: ansible_os_family == "Darwin"
